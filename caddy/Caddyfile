{
  email iam@dmitrybond.tech
}

dmitrybond.tech, www.dmitrybond.tech {
  encode zstd gzip

  # Статика Astro (смонтируем в /srv/dmb/site)
  root * /srv/dmb/site
  file_server

  # Кеш: HTML — не кешировать; ассеты — кешировать надолго
  @html path *.html
  header @html Cache-Control "no-cache, no-store, must-revalidate"
  header /_astro/* Cache-Control "public, max-age=31536000, immutable"
  header /assets/*  Cache-Control "public, max-age=31536000, immutable"

  # Редирект с корня на английскую версию
  @root path /
  redir @root /en/ 302

  # Прокси только для Cal
  handle_path /en/bookme* {
    reverse_proxy cal:3000
  }
  handle_path /ru/bookme* {
    reverse_proxy cal:3000
  }

  tls /etc/certs/cf-origin.pem /etc/certs/cf-origin.key

  # Кастомные ошибки (если файлы есть в /srv/dmb/site)
  handle_errors {
    @404 expression {http.error.status_code} == 404
    handle @404 {
      rewrite * /404.html
      file_server
    }
    @5xx expression {http.error.status_code} >= 500
    handle @5xx {
      rewrite * /500.html
      file_server
    }
  }
}